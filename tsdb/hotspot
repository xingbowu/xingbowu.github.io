HiTSDB 之时间序列中的热点问题解决

在tsdb场景下通常会出现两种热点场景

1. 单一热点指标

   生产环境中业务方采集的指标类型多种多样，对指标的采集周期各不相同。比如cpu.usage这个指标的变化频率比较快，业务方关注度高，采集周期通常很短，1秒，5秒，10秒等等。然而指标disk.usage这个指标变化趋势相对平滑，采集周期通常为1分钟，5分钟， 10分钟等。这种情况下，数据的存储如果针对同一个指标不做特殊处理，容易形成热点问题。
   
   假设按照指标类型进行存储资源的分片，想象一下如果有20个业务，每个业务10个集群，每个集群500台主机，采集周期是1秒的话，每秒就会有10万个cpu.usage的指标数据点落到同一个存储资源实例中，而disk.usage采集周期为1分钟，所以大约只有1666个指标数据点落到另外一个存储资源上，这样就形成了资源的浪费。
   
   假设按照时间戳进行存储资源的分片，读取时会形成全局扫表的问题，并且在采集周期的重合时刻依然存在写入热点的可能性。
   
   这类问题的经典解法就是分桶。比如除了指标类型外，同时将业务名和主机名作为维度标识tags，把指标cpu.usage划分到不同的桶里面。写入时根据桶id分散写入，查询时并发读取各个分桶中的数据，汇聚后统一返回。
   bucketId = hash(metric+tags) % (number of bucket)。


![_E6_97_A0_E6_A0_87_E9_A2_98](http://git.cn-hangzhou.oss.aliyun-inc.com/uploads/middleware-expert/doc/8d0cbdcab8691bcba14b72ae998a2018/%E6%97%A0%E6%A0%87%E9%A2%98.png)
